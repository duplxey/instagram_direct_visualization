{% load static %}

<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>instagram_direct_visualization</title>
        <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0"></script>
        <style>
            .card {
                margin-top: 16px;
            }
        </style>
    </head>
    <body>
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
            <div class="container">
                <a class="navbar-brand" href="#">instagram_direct_visualization</a>
           <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
           <span class="navbar-toggler-icon"></span>
           </button>
           <div class="collapse navbar-collapse" id="navbarSupportedContent">
              <ul class="navbar-nav mr-auto">
                 <li class="nav-item active">
                    <a class="nav-link" href="#">Home <span class="sr-only">(current)</span></a>
                 </li>
                 <li class="nav-item">
                    <a class="nav-link" href="#">Link</a>
                 </li>
                 <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    Dropdown
                    </a>
                    <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                       <a class="dropdown-item" href="#">Action</a>
                       <a class="dropdown-item" href="#">Another action</a>
                       <div class="dropdown-divider"></div>
                       <a class="dropdown-item" href="#">Something else here</a>
                    </div>
                 </li>
                 <li class="nav-item">
                    <a class="nav-link disabled" href="#">Disabled</a>
                 </li>
              </ul>
              <form class="form-inline my-2 my-lg-0">
                 <input class="form-control mr-sm-2" type="search" placeholder="Search" aria-label="Search">
                 <button class="btn btn-outline-success my-2 my-sm-0" type="submit">Search</button>
              </form>
           </div>
            </div>
        </nav>
        <script>
            const color_palette = [
                "#8ABBFE",
                "#BCE4A6",
                "#FFFD98",
                "#CF89AB",
                "#E68F64",
            ];

            let times = [
              "00", "01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11",
              "12", "13", "14", "15", "16", "17", "18", "19", "20", "21", "22", "23"
            ];

            let messageMap = new Map([]);
            let messageAmountMap = new Map([]);
            let messageTimesMap = new Map([]);

            for (let i = 0; i < times.length; i++) {
                messageTimesMap.set(times[i], 0);
            }

            fetch("get/")
              .then(res => res.json())
              .then((result) => {
                  for (let i = result.length-1; i >= 0; i--) {
                      let conversation = result[i]['conversation'];
                      for (let j = conversation.length-1; j >= 0; j--) {
                          let message = conversation[j];
                          let created_at = message['created_at'];
                          let sender = message['sender'];
                          let text = message['text'];

                          let month = created_at.substring(0, 7);
                          let hour = created_at.substring(11, 13);

                          {#let my_time = new Date(created_at).toLocaleString("en-US", {timeZone: "Europe/Berlin"});#}

                          console.log(created_at);

                          messageTimesMap.set(hour, messageTimesMap.has(hour) ? messageTimesMap.get(hour) + 1 : 1);

                          if (!messageMap.has(sender)) {
                              let a = {};
                              a[month] = {text};
                              messageMap.set(sender, a);
                          } else {
                              let current = messageMap.get(sender);
                              if (current[month]) {
                                  current[month] = Array.from(current[month]).concat(text);
                              } else {
                                  current[month] = {
                                      ...current[month],
                                      text,
                                  };
                              }
                          }
                          console.log(message.sender + " -> " + message.text);
                      }
                  }
                  console.log(result);
                  console.log(messageMap);

                  {#messageMap.forEach((key, value) => {#}
                  {#    for (let i = 0; i < value.length; i++) {#}
                  {#        let date = value[i];#}
                  {#        let b = {};#}
                  {#        b[]#}
                  {#    }#}
                  {##}
                  {#    let b = {};#}
                  {#    b[]#}
                  {#    messageAmountMap.set(key, b);#}
                  {# }); #}

                  console.log(messageAmountMap);


                  let months = Object.keys(messageMap.values().next().value);
                  console.log(months);

                  console.log(messageTimesMap);


                  // =======================================================================================
                  // Draw all the graphs
                  // =======================================================================================

                  var generalCtx = document.getElementById('generalChart').getContext('2d');
                    var generalChart = new Chart(generalCtx, {
                        type: 'doughnut',
                        data: {
                            labels: ['You', 'Them'],
                            datasets: [{
                                label: '# of Votes',
                                data: [55, 25],
                                backgroundColor: [
                                    color_palette[0],
                                    color_palette[1],
                                ],
                                borderWidth: 5,
                            }]
                        },
                        options: {
                            legend: {
                                position: 'top',
                            },
                        },
                    });

                    var heartedCtx = document.getElementById('heartedChart').getContext('2d');
                    var heartedChart = new Chart(heartedCtx, {
                        type: 'doughnut',
                        data: {
                            labels: ['You', 'Them'],
                            datasets: [{
                                data: [55, 25],
                                backgroundColor: [
                                    color_palette[3],
                                    color_palette[4],
                                ],
                                borderWidth: 5,
                            }]
                        },
                        options: {
                            legend: {
                                position: 'top',
                            },
                        },
                    });

                    var messageCtx = document.getElementById('messageChart').getContext('2d');
                    var messageChart = new Chart(messageCtx, {
                        type: 'line',
                        data: {
                            labels: months,
                            datasets: [{
                                label: '# of your messages',
                                data: [12, 19, 3, 5, 2, 3],
                                backgroundColor: [
                                    color_palette[0],
                                ],
                                borderWidth: 1
                            },
                            {
                                label: '# of their messages',
                                data: [12, 3, 3, 5, 2, 3],
                                backgroundColor: [
                                    color_palette[1],
                                ],
                                borderWidth: 1
                            },
                            {
                                label: '# of all messages',
                                data: [12, 3, 3, 5, 2, 5],
                                backgroundColor: [
                                    color_palette[2],
                                ],
                                borderWidth: 1
                            }]
                        },
                        options: {
                            scales: {
                                yAxes: [{
                                    ticks: {
                                        beginAtZero: true
                                    }
                                }]
                            }
                        }
                    });

                    var messageLengthCtx = document.getElementById('messageLengthChart').getContext('2d');
                    var messageLengthChart = new Chart(messageLengthCtx, {
                        type: 'line',
                        data: {
                            labels: months,
                            datasets: [{
                                label: '# of your characters',
                                data: [12, 19, 3, 5, 2, 3],
                                backgroundColor: [
                                    color_palette[0],
                                ],
                                borderWidth: 1
                            },
                            {
                                label: '# of their characters',
                                data: [12, 3, 3, 5, 2, 3],
                                backgroundColor: [
                                    color_palette[1],
                                ],
                                borderWidth: 1
                            },
                            {
                                label: '# average characters',
                                data: [12, 3, 3, 5, 2, 5],
                                backgroundColor: [
                                    color_palette[2],
                                ],
                                borderWidth: 1
                            }]
                        },
                        options: {
                            scales: {
                                yAxes: [{
                                    ticks: {
                                        beginAtZero: true
                                    }
                                }]
                            }
                        }
                    });

                    var messageLengthBarCtx = document.getElementById('messageLengthBar').getContext('2d');
                    var messageLengthBar = new Chart(messageLengthBarCtx, {
                       type: "horizontalBar",
                       data: {
                          labels: [
                             "You",
                             "Them",
                          ],
                          datasets: [
                             {
                                data: [
                                   65,
                                   59,
                                ],
                                fill: false,
                                backgroundColor: [
                                   color_palette[0],
                                   color_palette[1],
                                ],
                                borderWidth: 1
                             }
                          ]
                       },
                       options: {
                           legend: false,
                          scales: {
                             xAxes: [
                                {
                                   ticks: {
                                      beginAtZero: true
                                   }
                                }
                             ]
                          }
                       }
                    });

                    var messageTimesCtx = document.getElementById('messageTimesChart').getContext('2d');
                    var messageTimesChart = new Chart(messageTimesCtx, {
                        type: 'bar',
                        data: {
                            labels: times,
                            datasets: [{
                                label: '# of your messages',
                                data: [12, 19, 3, 5, 2, 3],
                                backgroundColor: [
                                    color_palette[0],
                                ],
                                borderWidth: 1
                            }]
                        },
                        options: {
                            scales: {
                                yAxes: [{
                                    ticks: {
                                        beginAtZero: true
                                    }
                                }]
                            }
                        }
                    });

                    var yourMostUsedWordsCtx = document.getElementById('yourMostUsedWordsChart').getContext('2d');
                    var yourMostUsedWordsChart = new Chart(yourMostUsedWordsCtx, {
                        type: 'bubble',
                        data: {
                            datasets: [{
                                label: ["word1"],
                                data: [
                                    {x: 0, y: 2, r: 10},
                                ],
                                backgroundColor: [
                                    color_palette[0],
                                ],
                            },
                            {
                                label: ["word2"],
                                data: [
                                    {x: 1, y: 2, r: 15},
                                ],
                                backgroundColor: [
                                    color_palette[0],
                                ],
                            }]
                        },
                        options: {
                            legend: {
                                display: false,
                            },
                            scales: {
                                xAxes: [{
                                    display: false,
                                }],
                                yAxes: [{
                                    display: false,
                                }]
                            },
                            layout: {
                                padding: {
                                    left: 100,
                                    right: 100,
                                    top: 50,
                                    bottom: 50
                                }
                            }
                        }
                    });

                    var theirMostUsedWordsCtx = document.getElementById('theirMostUsedWordsChart').getContext('2d');
                    var theirMostUsedWordsChart = new Chart(theirMostUsedWordsCtx, {
                        type: 'bubble',
                        data: {
                            datasets: [{
                                label: ["word1"],
                                data: [
                                    {x: 0, y: 2, r: 10},
                                ],
                                backgroundColor: [
                                    color_palette[0],
                                ],
                            },
                            {
                                label: ["word2"],
                                data: [
                                    {x: 1, y: 2, r: 15},
                                ],
                                backgroundColor: [
                                    color_palette[0],
                                ],
                            }]
                        },
                        options: {
                            legend: {
                                display: false,
                            },
                            scales: {
                                xAxes: [{
                                    display: false,
                                }],
                                yAxes: [{
                                    display: false,
                                }]
                            },
                            layout: {
                                padding: {
                                    left: 100,
                                    right: 100,
                                    top: 50,
                                    bottom: 50
                                }
                            }
                        }
                    });

                },
                (error) => {
                  console.log("Failed to fetch the data!");
                  console.log(error);
                }
              );
        </script>
        <div class="container">
            <div class="row">
                <div class="col-12 col-md-5">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">General</h5>
                            <p class="card-text">
                                All messages: x (100%)<br>
                                Your messages: y (share %)<br>
                                Their messages: z (share %)<br>
                                <hr>
                                <canvas id="generalChart" class="chart" width="400" height="200"></canvas>
                            </p>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Message length</h5>
                            <p class="card-text">
                                Your message length: x<br>
                                Their message length: y<br>
                                Your words per message: z<br>
                                Their words per message: k<br>
                                <hr>
                                <canvas id="messageLengthBar" class="chart" width="400" height="200"></canvas>
                            </p>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Hearted</h5>
                            <p class="card-text">
                                All liked: x (100%)<br>
                                You liked: y (share %)<br>
                                They liked: z (share %)<br>
                                <hr>
                                <canvas id="heartedChart" class="chart" width="400" height="200"></canvas>
                            </p>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-md-7">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Messages over time (months)</h5>
                            <p class="card-text">
                                <canvas id="messageChart" width="400" height="200"></canvas>
                            </p>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Messages length over time (months)</h5>
                            <p class="card-text">
                                <canvas id="messageLengthChart" width="400" height="200"></canvas>
                            </p>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Messaging times</h5>
                            <p class="card-text">
                                <canvas id="messageTimesChart" width="400" height="200"></canvas>
                            </p>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Emojis / emoticons share</h5>
                            <p class="card-text">
                                <ul>
                                    <li>1x :smilley:</li>
                                    <li>1x :smilley:</li>
                                    <li>1x :smilley:</li>
                                </ul>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Your most used words</h5>
                    <p class="card-text">
                        <canvas id="yourMostUsedWordsChart" width="400" height="200"></canvas>
                    </p>
                </div>
            </div>
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Their most used words</h5>
                    <p class="card-text">
                        <canvas id="theirMostUsedWordsChart" width="400" height="200"></canvas>
                    </p>
                </div>
            </div>
        </div>
    </body>
</html>